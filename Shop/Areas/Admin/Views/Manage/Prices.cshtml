
@{
    ViewBag.Title = "Цены";
}

<table id="jqGrid"></table>
<div id="jqGridPager"></div>

<script src="~/Scripts/jquery-3.2.1.min.js"></script>
<script src="~/Scripts/i18n/grid.locale-ru.js"></script>
<script src="~/Scripts/jquery.jqGrid.min.js" type="text/javascript"></script>

<link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
<link href="~/Content/jquery.jqGrid/ui.jqgrid.css" rel="stylesheet" type="text/css" />


<script type="text/javascript">
    $(document).ready(function () {

        $("#jqGrid").jqGrid({
            url: '@Url.Action("GetPrices","Manage")',
            mtype: "GET",
            datatype: "json",
            editurl: '@Url.Action("EditPrice", "Manage", new { Area = "Admin"})',
            colModel: [

                {
                    label: 'Код',
                    name: 'Id',
                    key: true,
                    width: 150,
                    editable: true,
                    editoptions: { readonly: "readonly" }
                },
                {
                    label: 'Тип товара', name: 'ProductTypeName', width: 150, editable: true, edittype:"select",
                    editoptions: {
                        dataUrl: '@Url.Action("GetProductTypesSelectList", "Service", new { Area = ""})',
                        dataEvents: [{ type: 'change', fn: function(e) {

                            var thisval = $(e.target).val();

                            $.get(
                                '@Url.Action("GetProductsSelectList", "Service", new { Area = ""})' + '?groupId=' + thisval, function (data) {

                                    var rowId = $("#jqGrid").jqGrid('getGridParam', 'selrow');
                                    $("#" + rowId + "_ProductName").html(data);

                                });

                        } }]
                    },
                    editrules: {
                        required: true
                    }

                },
                {
                    label: 'Товар', name: 'ProductName', width: 150, editable: true, edittype:"select",
                    editoptions: {
                        dataUrl: '@Url.Action("GetProductsSelectList", "Service", new { Area = ""})'
                        //value: function() {

                        //    var rowId = $("#jqGrid").jqGrid('getGridParam', 'selrow');
                        //    console.log($("#jqGrid").jqGrid('getRowData', rowId));

                        //    //var rowId = $("#jqGrid").jqGrid('getGridParam', 'selrow');
                        //    //var groupId = $("#" + rowId + "_ProductTypeName");

                        //    //console.log(groupId);

                        //    //console.log(groupId.val());

                        //}
                    },
                    editrules: {
                        required: true
                    }
                },
                {
                    label: 'Тип цены', name: 'PriceType', width: 150, editable: true, edittype: "select",
                     editoptions: {
                        dataUrl: '@Url.Action("GetPriceTypesSelectList", "Service", new { Area = ""})',
                    },
                     editrules: {
                         required: true
                    }
                },
                {
                    label: 'Цена', name: 'Price', width: 150, editable: true,
                    editrules: {
                        number: true,
                        required: true
                    }
                },
                {
                    label: "Действия",
                    name: "actions",
                    width: 100,
                    formatter: "actions",
                    formatoptions: {
                        keys: true,
                        addOptions: {},
                        editOptions: {},
                        delOptions: {}
                    }
                }
            ],
            jsonReader: { repeatitems: false },
            loadonce : true,
            viewrecords: true,
            onSelectRow: function(rowId) {
                console.log($("#jqGrid").jqGrid('getRowData', rowId));
                console.log($("#jqGrid").jqGrid('getCell', rowId, 'ProductName'));
            },
            width: 1000,
            height: 400,
            rowNum: 20,
            pager: "#jqGridPager"

        });

        $('#jqGrid').navGrid("#jqGridPager", {edit: false, add: false, del: false, refresh: false, view: false});
        $('#jqGrid').inlineNav('#jqGridPager',
            // the buttons to appear on the toolbar of the grid
            {
                edit: false,
                add: true,
                del: false,
                cancel: true,
                editParams: {
                    keys: true
                },
                addParams: {
                    keys: true
                }
            });

    });

</script>